---
title: "Visualización y geolocalización de datos"
subtitle: "Máster en Data Science & Business Analytics (con R Software)"
author:
- Gema Fernández-Avilés
- Diego Hernangómez
date: "`r Sys.Date()`"
bibliography: refbib.bib
csl: apa-6th-edition.csl
editor_options:
  markdown:
    wrap: 80
  chunk_output_type: console
output: 
  html_document: 
    toc: yes
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE,
  message = FALSE,
  out.width = "70%"
)


```



<center>
<img src="logo_mdsr_uclm.png" height="100px"/>
</center>



**Objetivos de aprendizaje**


# ¿Por dóne empezamos? Recursos interesantes



Web: 

* [rspatial](https://rspatial.org/)
* [R-spatial](https://r-spatial.org/projects/)



Libros de referencia: 

* [Spatial Data Science with applications in R](https://keen-swartz-3146c4.netlify.app/)

* [Geocomputation with R](https://geocompr.robinlovelace.net/)

* [Displaying time series, spatial and space-time data with R](https://oscarperpinan.github.io/bookvis/)



La idea es que en los apuntes el código vaya oculto y luego se lo pasamos. ¿Te parece bien?

# ¿Por qué estadística espacial?




# Datos espaciales

Los **datos espaciales**, también conocidos como datos **geoespaciales**, describen cualquier dato relacionado o que contenga información sobre una ubicación específica en la superficie de la Tierra. Son datos anclados al espacio que proporcionan información sobre él.


<!-- GEMA; ESTO MEJOR EN SU CAPITULO CORRESPONDIENTE -->

<!-- ### Tipos de datos espaciales -->

<!-- De una manera resumida, los datos espaciales son aquellos datos relacionados o -->

<!-- que contienen información de una localización o área geográfica de la superficie -->

<!-- de la Tierra. -->

<!-- Existen varias maneras de clasificar los datos espaciales. @cressie1993 propone -->

<!-- la siguiente clasificación: -->

<!-- 1.  **Datos geoestadísticos:** GEMA! -->

<!-- 2.  **Datos *lattice*:** GEMA! -->

<!-- 3.  **Point pattern:** GEMA! -->

En el ámbito del análisis espacial en **R**, se pueden clasificar los datos
espaciales en función del modelo de datos [@geodata]. Se pueden distinguir dos
tipos de modelos de datos:

## Datos vector

Este modelo está basado en puntos georeferenciados. Los puntos pueden
representar localizaciones específicas, como la localización de edificios:

```{r puntos}
library(ggplot2)
library(sf)
# Hospitales en Toledo segun Eurostat
hosp_toledo <- st_read("data/hosp_toledo.geojson", quiet = TRUE)
ggplot() +
  geom_sf(
    data = hosp_toledo, aes(fill = "Centros Sanitarios"),
    color = "blue"
  ) +
  labs(
    caption = "Datos: Eurostat",
    title = "Hospitales y Centros de Salud en Toledo",
    fill = ""
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

Estos puntos también pueden estar conectados entre sí, de manera que formen
geometrías más complejas, como líneas y polígonos:

```{r lineas_pol}
tajo <- st_read("data/tajo_toledo.shp", quiet = TRUE)
toledo <- st_read("data/toledo_ciudad.gpkg", quiet = TRUE)
ggplot(toledo) +
  geom_sf(fill = "cornsilk2") +
  geom_sf(data = tajo, col = "lightblue2", lwd = 2, alpha = 0.7) +
  geom_sf(data = hosp_toledo, col = "blue") +
  coord_sf(
    xlim = c(-4.2, -3.8),
    ylim = c(39.8, 39.95)
  ) +
  theme_minimal() +
  labs(title = "Ciudad de Toledo")
```

En el ejemplo anterior, el río Tajo está representado como una línea (sucesión
de puntos unidos entre sí) y la ciudad de Toledo como un polígono (línea de
puntos cerrada formando un continuo). A modo ilustrativo, podemos observar la
descomposición en puntos de todos los datos espaciales representados en el
gráfico anterior.

```{r lineas_pol_desc, echo=FALSE}
ggplot(st_cast(toledo, "POINT")) +
  geom_sf(col = "cornsilk3") +
  geom_sf(
    data = st_cast(tajo, "POINT"),
    col = "lightblue2"
  ) +
  geom_sf(data = hosp_toledo, col = "blue") +
  coord_sf(
    xlim = c(-4.2, -3.8),
    ylim = c(39.8, 39.95)
  ) +
  theme_minimal() +
  labs(title = "Ciudad de Toledo: Descomposición")
```

## Datos raster

Los datos ráster son datos representandos en una rejilla rectangular de píxeles
(denomindada **matriz**) que se puede visualizar en diversos dispositivo de
representación. El caso más cotidiano de un ráster es una fotografía, donde la
imagen se representa como una serie de celdas, determinadas por la resolución de
la imagen (número total de píxeles, determinados como nº de píxeles en cada fila
por nº de píxeles en cada columna) y el color que presenta cada uno de estos
píxeles.

En el ámbito de los datos espaciales, la definición es muy similar. Un archivo
ráster está formado por una malla regular de píxeles georreferenciada:

```{r raster}
library(terra)
elev <- rast("data/Toledo_DEM.tiff")
plot(elev, main = "Elevación de la provincia de Toledo")
# Mostramos el grid
pols <- as.polygons(elev)
plot(pols, add = TRUE, border = "grey90")
# Añadimos la provincia
Tol_prov <- st_read("data/Toledo_prov.gpkg", quiet = TRUE)
plot(st_geometry(Tol_prov), add = TRUE)
```

En el ejemplo anterior, el archivo ráster tiene únicamente una capa (ESP_alt).
Eso implica que cada píxel tiene asociado un único valor, en este caso, la
altitud media del terreno observada en cada píxel o celda.

```{r detalle_pixel, echo=FALSE}
library(dplyr)
as.data.frame(elev, xy = TRUE) %>%
  as_tibble() %>%
  head(15) %>%
  knitr::kable(caption = "Datos de un ráster (detalle)")
# Subset de las primeras 15 celdas
top15 <- elev[1, 1:15, drop = FALSE]
plot(top15, main = "Detalle de los primeros 15 pixels")
```

Los rásters pueden contener varias capas (o layers), de manera que cada píxel
puede tener asociados varios valores. Volviendo al ejemplo de la fotografía, en
un modelo simple de color RGB cada píxel lleva asociado 3 valores (rojo, verde o
azul), de manera que al combinar las tres capas se puede definir un color
distinto en cada píxel.

En el siguiente ejemplo vamos a usar una imagen de mapa georreferenciada, como
las proporcionadas por servicios de mapas online, para analizar su composición.

```{r raster_multilayer}
tile <- rast("data/Toledo_multi_tile.tiff")
plotRGB(tile, mar = c(0, 0, 2, 0), main = "Provincia de Toledo")
plot(st_geometry(Tol_prov), add = TRUE)
```

El ráster se puede descomponer en las tres capas RGB mencionadas anteriormente:

```{r detalle_pixel_multicapa, echo=FALSE}
as.data.frame(tile, xy = TRUE) %>%
  as_tibble() %>%
  head(15) %>%
  knitr::kable(caption = "Datos de un ráster multicapa (detalle)")
# Subset de las primeras 15 celdas
top15_2 <- tile[1:100, 1:100, drop = FALSE]
plotRGB(top15_2, mar = c(0, 0, 2, 0), main = "Imagen: Detalle")
plot(top15_2,
  mar = c(0, 0, 2, 4), main = "Imagen: Detalle capas",
  axes = FALSE,
  range = c(0, 255)
)
```

Y cada capa se puede graficar de manera independiente

```{r raster_multilayer_desc, fig.show='hold'}
plot(tile$lyr.1,
  main = "Raster tile: Layer 1",
  col = hcl.colors(255, "Reds", rev = TRUE),
  range = c(0, 255)
)
plot(tile$lyr.2,
  main = "Raster tile: Layer 2",
  col = hcl.colors(255, "Greens", rev = TRUE),
  range = c(0, 255)
)
plot(tile$lyr.3,
  main = "Raster tile: Layer 3",
  col = hcl.colors(255, "Blues", rev = TRUE),
  range = c(0, 255)
)
```



La forma más intuitiva de representar los datos espaciales es a través de un mapa.

```{r echo=FALSE}
# Population density of Spain

library(ggplot2)
library(mapSpain)
library(sf)

pop <- mapSpain::pobmun19
munic <- esp_get_munic()

# Get area (km2) - Use LAEA projection
municarea <- as.double(st_area(st_transform(munic, 3035)) / 1000000)
munic$area <- municarea

munic.pop <- merge(munic, pop, all.x = TRUE, by = c("cpro", "cmun"))
munic.pop$dens <- munic.pop$pob19 / munic.pop$area

br <-
  c(
    -Inf,
    10,
    25,
    100,
    200,
    500,
    1000,
    5000,
    10000,
    Inf
  )


munic.pop$cuts <- cut(munic.pop$dens, br)

ggplot(munic.pop) +
  geom_sf(aes(fill = cuts), color = NA, lwd = 0) +
  scale_fill_manual(
    values = c("grey5", hcl.colors(
      length(br) - 2,
      "Spectral"
    )),
    labels = prettyNum(c(0, br[-1]), big.mark = ","),
    guide = guide_legend(
      title = "Pop. per km2",
      direction = "horizontal",
      nrow = 1,
      keywidth = 2,
      title.position = "top",
      label.position = "bottom"
    )
  ) +
  labs(title = "Population density in Spain (2019)") +
  theme_void() +
  theme(
    plot.title = element_text(hjust = .5),
    plot.background = element_rect(fill = "black"),
    text = element_text(colour = "white"),
    legend.position = "bottom"
  )
```


Los formatos más comunes de datos espaciales son vectores y ráster.

* El modelo de **datos vectoriales** representa el mundo mediante puntos, líneas y polígonos. Estos tienen bordes discretos y bien definidos, lo que significa que los conjuntos de datos vectoriales suelen tener un alto nivel de precisión.

* El modelo de **datos ráster** divide la superficie en celdas de tamaño constante. Los conjuntos de datos ráster son la base de las imágenes de fondo que se utilizan en la cartografía web y han sido una fuente vital de datos geográficos desde los orígenes de la fotografía aérea y los dispositivos de teledetección basados en satélites.




## Datos vectoriales

cUALQUIER EJEMPLO, EL ANTERIOR?


## Datos raster
AQUÍ EL MAPA RASTER DE LA PALMA?










## Geocomputación. ¿Qué es?  PUEDO EMPEZAR YO Y LUEGO DIEGO LE DAS UNA VUELTA

La geocomputación es un término relativamente nuevo pero influenciado por otros términos clasiscos. Es decir, puede ser visto como una parte de la Geografía, la cual tiene más de 2000 años de historia (Talbert_2014) o como una extensión de los Sistemas de Información Geográfica comunmente conocidos por GIS (del inglés, Geographic Information Systems) (Neteler and Mitasova 2008), los cuales emergieron en la década de los 60 (Coppock and Rhind 1991).

Según @Lovelance_et_al_2019, el término Geocomputación se utilizó por primera vez en 1996 en la primera conferencia que trataba de Geocomputación. @Openshaw_Abrahart_2000 definenen la geocomputación como una herramienta que trata de utilizar los diferentes tipos de datos geográficos y de desarrollar herramientas geográficas relevantes dentro del contexto general de un enfoque 'científico'.

La geocomputación está estrechamente relacionada con otros términos que incluyen: 

* la ciencia de la información geográfica (GIScience),

* la geomática,

* la Geoinformática,

* la ciencia de la información espacial

* la ingeniería de Geoinformación (P. Longley 2015)

* y ciencia de datos geográficos (GDS, Geographic Data Science). 

Cada término comparte un énfasis en un enfoque *"**científico** (que implica reproducible y falsable) influenciado por los SIG, aunque sus orígenes y principales campos de aplicación difieren. 

GDS, por ejemplo, enfatiza las habilidades de "ciencia de datos" y grandes conjuntos de datos, mientras que la geoinformática tiende a enfocarse en estructuras de datos. Pero las superposiciones entre los términos son más grandes que las diferencias entre ellos y usamos geocomputación como un sinónimo aproximado que los encapsula a todos: todos buscan usar datos geográficos para trabajos científicos aplicados.




Resumir del libro @Lovelance_et_al_2019
Empezar ilustrando con un ejemplo

Tenemos los datos de movilidad, los de Murcia depurados, son de data gob, pueden estar bien para empezar o para coger los de Madrid.


## El ecosistema Rspatial  PUEDO EMPEZAR YO Y LUEGO DIEGO LE DAS UNA VUELTA
Resumir del libro @Lovelance_et_al_2019
Para dar una pincelada




# Datos geográficos en R 



## Marcos de Referencia para Sistemas de Coordenadas (CRS)  **DIEGO **
Resumir del libro @Lovelance_et_al_2019 o lo que considere DIEGO

## Formatos de ficheros de datos espaciales  **DIEGO **
Aquí había pensado habar de los SHP o los formatos que se lleven ahora, sf, tmap, mapSpain, terra,  DIEGO

Todo muy sencillo y con un ejemplito


## Tipos de datos espaciales  (GEMA) o estadística espacial

- Procesos de puntos: Datos 112-Valencia, me los pasa Jorge.

- Geoestadística: Temperatua mínima? 

- Econometría espacial: Diego: económico a nivel municipal para España (PIB, PARO, gini, algo que puedas unir directamente de tidyBdE y mapSpain..)

Todo muy sencillo y con un ejemplo


.


# Construyendo mapas en R  **Este punto y el anterior los podemos hablar para centrar los ejemplos y luego vemos como lo hacemos**

## Mapas temáticos 

mapSpain, tmap
Datos que ya tenemos:
-Medioambiente Madrid.
-Temperatura mínima ESpaña
- Alguno económico a nivel municipal para españa (PIB, PARO,..)
- Alguno de La Palma.


## Aplicaciones en R 
- Aplicaciones a la economía, salud, marketing, etc

** VER COMO LO HACEMOS PARA QUE NO QUEDE REDUNDANTE.

## Mapas interactivos en R con Leaflet (sobra?) mejor algo de espacio-temporal





# References
